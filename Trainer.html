<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Health Monitoring System - Trainer Dashboard">
    <title>Trainer Dashboard - Health Monitoring System</title>
    <!-- Load Inter font for better typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
    /* Reset and General Styles */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* Added smooth scrolling for anchors */
    html {
        scroll-behavior: smooth; 
    }

    body {
        background-color: #121212;
        color: rgb(224, 224, 224);
        line-height: 1.6;
        font-family: 'Inter', sans-serif; /* Using Inter font */
        min-height: 100vh;
        display: flex; /* Ensures the wrapper fills the viewport */
    }

    .wrapper {
        display: flex;
        width: 100%;
        max-width: 100vw;
    }

    /* Sidebar */
    .sidebar {
        width: 250px;
        background: rgb(34, 34, 34);
        color: white;
        flex-shrink: 0;
    }

    .brand {
        padding: 20px;
        background: rgb(34, 34, 34);
        text-align: center;
        border-bottom: 1px solid #2a2a2a;
    }

    .brand h2 {
        font-size: 22px;
        margin-top: 10px;
        color: rgb(0, 188, 140);
        font-weight: 700;
    }

    .menu ul {
        list-style: none;
        padding: 10px 0;
    }

    .menu li {
        margin: 5px 0;
        border-radius: 8px; /* Added rounded corners to li for better aesthetics */
    }

    .menu a {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        color: #ddd;
        text-decoration: none;
        transition: all 0.3s;
        font-size: 16px;
        border-radius: 8px;
    }

    .menu a:hover,
    .menu a.active {
        background: rgba(0, 188, 140, 0.1); /* Lighter hover effect */
        color: white;
        border-left: 4px solid rgb(0, 188, 140);
        margin-left: -4px; /* Compensate for border shift */
    }

    /* Removed .menu a.sub-link styles as Logout is now in the modal */

    .menu .icon {
        margin-right: 12px;
        width: 20px;
        display: inline-block;
        text-align: center;
        font-size: 18px;
    }

    /* Main Content */
    .main {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: #151515;
    }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgb(51, 51, 51);
    }

    .header h1 {
        color: rgb(0, 188, 140);
        font-size: 28px;
        font-weight: 800;
    }

    .user {
        display: flex;
        align-items: center;
        background: rgb(34, 34, 34);
        padding: 10px 15px;
        border-radius: 12px; /* Smoother corners */
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        margin-right: 12px;
        border: 3px solid rgb(0, 188, 140);
        object-fit: cover;
    }

    .details h4 {
        margin-bottom: 3px;
        font-size: 16px;
        font-weight: 600;
    }

    .details p {
        color: rgb(149, 165, 166);
        font-size: 13px;
    }

    /* Dashboard Cards */
    .stats {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .card {
        background: rgb(26, 26, 26);
        border-radius: 12px; /* Smoother corners */
        padding: 25px;
        position: relative;
        overflow: hidden;
        border: 1px solid #2a2a2a;
        transition: transform 0.3s, box-shadow 0.3s;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
    }

    .card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 6px; /* Slightly thicker border */
        height: 100%;
        background-color: rgb(0, 188, 140);
        border-radius: 12px 0 0 12px;
    }

    .top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .title {
        font-size: 18px;
        color: rgb(0, 188, 140);
        font-weight: 600;
    }

    .icon-box { /* Changed class name to icon-box to avoid conflict with menu .icon */
        width: 50px;
        height: 50px;
        background: rgba(0, 188, 140, 0.15); /* Light green background */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: rgb(0, 188, 140);
        font-size: 22px;
    }

    .value {
        font-size: 36px; /* Larger value */
        font-weight: 800;
        margin: 10px 0;
        color: white;
    }

    .desc {
        color: rgb(149, 165, 166);
        font-size: 14px;
    }

    /* Tables and Panels */
    .panel {
        background: rgb(26, 26, 26);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 30px;
        overflow-x: auto;
        border: 1px solid #2a2a2a;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .topbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .topbar .group {
        display: flex;
        gap: 10px;
    }

    .heading {
        font-size: 24px;
        color: rgb(0, 188, 140);
        font-weight: 700;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px; /* Ensure table is readable on small screens */
    }

    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #333;
    }

    th {
        background-color: rgb(34, 34, 34);
        color: rgb(0, 188, 140);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 13px;
    }

    tr:nth-child(even) {
        background-color: #1e1e1e;
    }

    tr:hover {
        background-color: #252525;
        transition: background-color 0.2s;
    }

    .btn {
        padding: 10px 18px; /* Slightly larger buttons */
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        font-size: 12px;
    }

    .btn:active {
        transform: scale(0.98);
        box-shadow: none;
    }

    .primary {
        background: rgb(0, 188, 140);
        color: #121212; /* Dark text on bright background */
        box-shadow: 0 3px 6px rgba(0, 188, 140, 0.3);
    }

    .primary:hover {
        background: rgb(0, 163, 121);
    }

    .danger {
        background: #e74c3c;
        color: white;
    }

    .danger:hover {
        background: #c0392b;
    }

    .success {
        background: rgb(0, 188, 140);
        color: white;
    }
    
    .success:hover {
        background: rgb(0, 163, 121);
    }


    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        font-weight: 600;
        display: inline-block;
    }

    .good {
        background: rgba(0, 188, 140, 0.15);
        color: rgb(0, 188, 140);
    }

    .waiting {
        background: rgba(243, 156, 18, 0.15);
        color: rgb(243, 156, 18);
    }
    
    .completed {
        background: rgba(0, 188, 140, 0.15);
        color: rgb(0, 188, 140);
    }

    .upcoming {
        background: rgba(52, 152, 219, 0.15);
        color: rgb(52, 152, 219);
    }


    /* Charts */
    .charts {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart {
        background: rgb(26, 26, 26);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #2a2a2a;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .placeholder {
        height: 300px;
        background: #1e1e1e;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        color: rgb(149, 165, 166);
        font-style: italic;
        border: 2px dashed #333;
        animation: fadeIn 1.5s ease-in-out;
        gap: 10px;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    /* MODAL STYLES */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
    }

    .modal-overlay.open {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: #1e1e1e;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        transform: translateY(-50px);
        transition: transform 0.3s;
        overflow-y: auto; /* Allow scrolling inside modal if content is too long */
        max-height: 90vh; /* Limit max height */
    }
    
    .modal-content.lg {
        max-width: 900px; /* Wider modal for sessions table */
    }

    .modal-overlay.open .modal-content {
        transform: translateY(0);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 1px solid #333;
        padding-bottom: 10px;
    }

    .modal-header h3 {
        color: rgb(0, 188, 140);
        font-size: 20px;
        font-weight: 700;
    }

    .close-btn {
        background: none;
        border: none;
        color: #999;
        font-size: 24px;
        cursor: pointer;
        transition: color 0.2s;
    }

    .close-btn:hover {
        color: white;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #ccc;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #333;
        border-radius: 6px;
        background: #2a2a2a;
        color: white;
        font-size: 16px;
        transition: border-color 0.2s;
        -webkit-appearance: none; /* Remove default styling on select */
        -moz-appearance: none;
        appearance: none;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: rgb(0, 188, 140);
        outline: none;
    }
    
    /* Style file input separately as it's harder to fully style across browsers */
    .form-group input[type="file"] {
        padding: 8px 10px;
        background: #343434;
        border: 1px solid #444;
    }

    /* Style for checkboxes within the settings modal */
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        cursor: pointer;
    }
    .checkbox-group input[type="checkbox"] {
        width: auto;
        flex-shrink: 0;
        margin-right: 5px;
    }
    .checkbox-group span {
        font-size: 14px;
    }


    .form-actions {
        margin-top: 20px;
        text-align: right;
    }
    
    /* CHAT MODAL SPECIFIC STYLES */
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 400px; /* Fixed height for chat window */
        background: #1e1e1e;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: #191919;
    }

    .message-bubble {
        max-width: 85%; /* Increased max width */
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 15px;
        line-height: 1.4;
        position: relative;
    }

    .message-bubble p {
        margin: 0;
    }

    .sent {
        align-self: flex-end;
        background-color: rgb(0, 188, 140); /* Trainer (Sent) color */
        color: #121212;
        border-bottom-right-radius: 2px;
    }

    .received {
        align-self: flex-start;
        background-color: #343434; /* Client (Received) color */
        color: white;
        border-bottom-left-radius: 2px;
    }

    .timestamp {
        display: block;
        font-size: 10px;
        color: rgba(255, 255, 255, 0.7);
        text-align: right;
        margin-top: 5px;
    }
    
    .sent .timestamp {
        color: rgba(18, 18, 18, 0.7);
    }

    .chat-input-area {
        display: flex;
        padding: 10px;
        background: #2a2a2a;
        border-top: 1px solid #333;
        align-items: center; /* Vertically align items */
    }

    .chat-input-area input[type="text"] {
        flex-grow: 1;
        border: none;
        padding: 10px;
        border-radius: 20px;
        background: #191919;
        color: white;
        margin-right: 10px;
        height: 40px; /* Match button height */
    }
    
    .chat-input-area input[type="text"]:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgb(0, 188, 140);
    }

    .attachment-btn, .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
        flex-shrink: 0;
        padding: 0; /* Remove padding for better icon centering */
    }
    
    .attachment-btn {
        background: #3e3e3e;
        color: white;
        margin-right: 5px;
        font-size: 20px;
    }
    
    .attachment-btn:hover {
        background: #555;
    }

    .send-btn {
        background: rgb(0, 188, 140);
        color: #121212;
        font-size: 14px;
        padding-left: 2px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .send-btn:hover {
        background: rgb(0, 163, 121);
    }
    
    .attachment-info {
        font-size: 12px;
        margin-top: 5px;
        padding-top: 5px;
        border-top: 1px solid rgba(18, 18, 18, 0.2);
        font-weight: 500;
        color: #121212; /* Darker color for file link text */
    }
    /* END CHAT MODAL SPECIFIC STYLES */

    /* Sessions Table Styles inside modal */
    .sessions-table-container {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .sessions-table-container table {
        min-width: 100%;
        margin-top: 10px;
    }
    
    .sessions-table-container th {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .charts {
            grid-template-columns: 1fr;
        }
    }

    @media (max-width: 768px) {
        .wrapper {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
            height: auto;
        }
        
        /* Adjust menu to be horizontal when collapsed on mobile */
        .menu ul {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 10px 10px 10px;
        }
        
        .menu li {
            margin: 5px;
            flex-grow: 1;
            min-width: 100px;
            max-width: 48%;
        }

        .menu a {
             justify-content: center;
             padding: 8px 10px;
             text-align: center;
        }
        
        .menu .icon {
            margin-right: 5px;
        }


        .stats {
            grid-template-columns: 1fr;
        }

        .header {
            flex-direction: column;
            align-items: flex-start;
        }

        .user {
            margin-top: 15px;
            width: 100%;
            justify-content: center;
        }
        
        .modal-content {
            max-width: 95%; /* Adjust for very small screens */
        }
        
        .chat-container {
            height: 300px; /* Smaller height for mobile chat */
        }
        
        .modal-content.lg {
            max-width: 95%; 
        }
    }

    @media (max-width: 480px) {
        .main {
            padding: 15px;
        }

        .header h1 {
            font-size: 24px;
        }

        .value {
            font-size: 32px;
        }
        
        .topbar {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .btn {
            width: 100%;
            margin-top: 10px;
        }
    }

    .hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
    }
    </style>
</head>
<body>
    <div class="wrapper">
        <aside class="sidebar">
            <div class="brand">
                <!-- Replaced local image file with a simple, safe emoji logo -->
                <div style="font-size: 40px; color: rgb(0, 188, 140); line-height: 1;">üíñ</div>
                <h2>Health Tracker</h2>
            </div>
            <nav class="menu" aria-label="Main navigation">
                <ul>
                    <!-- 1. DASHBOARD: Links to the top section (Stats) -->
                    <li><a href="#dashboard-stats" class="active"><span class="icon">üè†</span> Dashboard</a></li>
                    <!-- 2. CLIENTS: Links to the Recent Clients table -->
                    <li><a href="#recent-clients-section"><span class="icon">üë•</span> Clients</a></li>
                    <!-- 3. ANALYTICS: Links to the Charts section -->
                    <li><a href="#charts-section"><span class="icon">üìä</span> Analytics</a></li>
                    <!-- 4. SCHEDULE: Links to the Today's Sessions table -->
                    <li><a href="#sessions-section"><span class="icon">üìÖ</span> Schedule</a></li>
                    <!-- Settings is now a primary link that opens the modal with integrated Logout -->
                    <li><a href="#" id="settings-link"><span class="icon">‚öôÔ∏è</span> Settings</a></li>
                </ul>
            </nav>
        </aside>

        <main class="main">
            <header class="header">
                <h1>Trainer Dashboard</h1>
                <div class="user">
                    <!-- Using a robust placeholder image URL for the avatar -->
                    <img class="avatar" src="https://placehold.co/45x45/00bc8c/ffffff?text=NT" onerror="this.src='https://placehold.co/45x45/515151/ffffff?text=NT';" alt="Trainer Photo of Naman Trainer">
                    <div class="details">
                        <h4>Naman Trainer</h4>
                        <p>Certified Fitness Coach</p>
                    </div>
                </div>
            </header>

            <!-- DASHBOARD STATS SECTION (Target 1) -->
            <section aria-labelledby="dashboard-cards-heading" id="dashboard-stats">
                <h2 id="dashboard-cards-heading" class="hidden">Dashboard Statistics</h2>
                <div class="stats">
                    <div class="card">
                        <div class="top">
                            <h3 class="title">Total Clients</h3>
                            <div class="icon-box">üë•</div>
                        </div>
                        <div class="value" id="total-clients-value">24</div>
                        <p class="desc"><span id="new-clients-desc">5 new clients this month</span></p>
                    </div>

                    <div class="card">
                        <div class="top">
                            <h3 class="title">Active Plans</h3>
                            <div class="icon-box">üìã</div>
                        </div>
                        <div class="value">38</div>
                        <p class="desc">18 meal plans, 20 workout plans</p>
                    </div>

                    <div class="card">
                        <div class="top">
                            <h3 class="title">Monthly Revenue</h3>
                            <div class="icon-box">üí∞</div>
                        </div>
                        <div class="value">$2,850</div>
                        <p class="desc">+$450 from last month</p>
                    </div>

                    <div class="card">
                        <div class="top">
                            <h3 class="title">Avg. Rating</h3>
                            <div class="icon-box">‚≠ê</div>
                        </div>
                        <div class="value">4.7/5</div>
                        <p class="desc">Based on 18 reviews</p>
                    </div>
                </div>
            </section>

            <!-- RECENT CLIENTS SECTION (Target 2) -->
            <section class="panel" aria-labelledby="recent-clients-heading" id="recent-clients-section">
                <div class="topbar">
                    <h3 class="heading" id="recent-clients-heading">Recent Clients</h3>
                    <!-- Added ID to the button for JavaScript targeting -->
                    <button class="btn primary" id="add-client-btn">Add New Client</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Gender</th>
                            <th>BMI</th>
                            <th>Join Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <!-- The tbody content will now be rendered dynamically by JavaScript -->
                    <tbody id="clients-table-body">
                        <!-- Content goes here -->
                    </tbody>
                </table>
            </section>

            <!-- CHARTS / ANALYTICS SECTION (Target 3) -->
            <section class="charts" aria-labelledby="charts-heading" id="charts-section">
                <h2 id="charts-heading" class="hidden">Progress Charts</h2>
                <div class="chart">
                    <div class="topbar">
                        <h3 class="heading">Client Progress Overview</h3>
                    </div>
                    <div class="placeholder">
                        <div style="font-size: 50px; opacity: 0.5;">üìà</div>
                        <p>Progress chart visualization would be displayed here</p>
                    </div>
                </div>
                <div class="chart">
                    <div class="topbar">
                        <h3 class="heading">BMI Distribution</h3>
                    </div>
                    <div class="placeholder">
                       <div style="font-size: 50px; opacity: 0.5;">üìä</div>
                        <p>BMI chart visualization would be displayed here</p>
                    </div>
                </div>
            </section>

            <!-- TODAY'S SESSIONS / SCHEDULE SECTION (Target 4) -->
            <section class="panel" aria-labelledby="sessions-heading" id="sessions-section">
                <div class="topbar">
                    <h3 class="heading" id="sessions-heading">Today's Sessions</h3>
                    <div class="group">
                        <!-- New Add Session button -->
                        <button class="btn primary" id="add-session-btn">Add New Session</button>
                        <!-- Existing View All button -->
                        <button class="btn primary" id="view-all-sessions-btn">View All</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <!-- Added ID to the tbody to delegate event listening for notes buttons -->
                    <tbody id="todays-sessions-body">
                        <!-- Content will be rendered dynamically by renderSessionsTable -->
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <!-- MODAL STRUCTURE (Hidden by default) -->
    <div class="modal-overlay" id="add-client-modal">
        <div class="modal-content" id="modal-content-area">
            <div class="modal-header">
                <h3 id="modal-title">Modal Title</h3>
                <button class="close-btn" id="close-modal-btn">&times;</button>
            </div>
            
            <!-- FORM CONTENT (Default for Add Client) -->
            <div id="add-client-form-content">
                <form id="new-client-form">
                    <div class="form-group">
                        <label for="client-name">Full Name</label>
                        <input type="text" id="client-name" name="name" required placeholder="e.g., Jane Doe">
                    </div>
                    <div class="form-group">
                        <label for="client-age">Age</label>
                        <input type="number" id="client-age" name="age" min="16" max="99" required placeholder="e.g., 35">
                    </div>
                    <div class="form-group">
                        <label for="client-gender">Gender</label>
                        <select id="client-gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="client-bmi">BMI (Body Mass Index)</label>
                        <input type="number" id="client-bmi" name="bmi" step="0.1" min="15" max="50" required placeholder="e.g., 23.5">
                    </div>
                    <div class="form-group">
                        <label for="client-status">Initial Status</label>
                        <select id="client-status" name="status" required>
                            <option value="Active">Active</option>
                            <option value="Evaluation">Evaluation</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn primary">Save Client</button>
                    </div>
                </form>
            </div>

            <!-- DYNAMIC CONTENT (Used for View/Message/Settings/Sessions) -->
            <div id="client-details-content" style="display: none;">
                <!-- Content injected here by JavaScript -->
            </div>
        </div>
    </div>
    
    <script>
        // --- DATA ---
        let clients = [
            { id: 1, name: "Sandeep Kumar", age: 32, gender: "Male", bmi: 24.2, joinDate: "2023-09-15", status: "Active", email: "sandeep.k@example.com" },
            { id: 2, name: "Naman Gupta", age: 45, gender: "Male", bmi: 28.7, joinDate: "2023-10-02", status: "Active", email: "naman.g@example.com" },
            { id: 3, name: "Karmandeep Singh", age: 29, gender: "Female", bmi: 22.5, joinDate: "2023-10-10", status: "Evaluation", email: "karma.s@example.com" },
            { id: 4, name: "RDJ", age: 38, gender: "Male", bmi: 26.8, joinDate: "2023-09-28", status: "Active", email: "rdj.client@example.com" },
            { id: 5, name: "Parampreet Singh", age: 41, gender: "Male", bmi: 25.3, joinDate: "2023-10-05", status: "Active", email: "param.s@example.com" },
        ];
        
        // Added unique IDs for sessions
        let sessions = [
            { id: 101, client: "Parampreet Singh", time: "9:00 AM - 10:00 AM", type: "Strength Training", status: "Completed", date: "2024-10-23", notes: "[Mock Notes] Excellent session, focusing on form correction during deadlifts. Client achieved 3 sets of 8 reps at 85% 1RM. Endurance is improving. Plan for next session: increase volume on squat. Mood: High energy." },
            { id: 102, client: "Naman Gupta", time: "11:00 AM - 12:00 PM", type: "Cardio", status: "Upcoming", date: "2024-10-23", notes: "[Mock Notes] Client confirmed attendance for this session. Focus will be on proper warm-up routine and core engagement." },
            { id: 103, client: "Karmandeep Singh", time: "3:00 PM - 4:00 PM", type: "Yoga", status: "Upcoming", date: "2024-10-23", notes: "[Mock Notes] Focus on flexibility and core strength improvement." },
            { id: 104, client: "RDJ", time: "6:00 PM - 7:00 PM", type: "HITT", status: "Upcoming", date: "2024-10-24", notes: "" },
            { id: 105, client: "Sandeep Kumar", time: "7:00 AM - 8:00 AM", type: "Endurance Run", status: "Completed", date: "2024-10-22", notes: "Strong pace maintained for 45 mins. Good breathing control." },
            { id: 106, client: "Naman Gupta", time: "10:00 AM - 11:00 AM", type: "Strength Training", status: "Completed", date: "2024-10-22", notes: "Hit new PR on bench press. Advised focus on shoulder mobility." },
            { id: 107, client: "Parampreet Singh", time: "8:00 AM - 9:00 AM", type: "Flexibility", status: "Completed", date: "2024-10-21", notes: "Successful session. Client is showing good commitment to stretching routine." },
            { id: 108, client: "Karmandeep Singh", time: "1:00 PM - 2:00 PM", type: "Assessment", status: "Completed", date: "2024-10-20", notes: "Initial fitness assessment complete. Baseline stats recorded." },
        ];

        let newClientsCount = 5; // Initial mock count for "5 new clients this month"
        let nextSessionId = 109; // Counter for new sessions

        // --- DOM ELEMENTS ---
        const tableBody = document.getElementById('clients-table-body');
        const todaysSessionsBody = document.getElementById('todays-sessions-body'); // New ID for sessions table body
        const modal = document.getElementById('add-client-modal');
        const modalContentArea = document.getElementById('modal-content-area');
        const addClientBtn = document.getElementById('add-client-btn');
        const addSessionBtn = document.getElementById('add-session-btn'); // New reference
        const closeModalBtn = document.getElementById('close-modal-btn');
        const clientForm = document.getElementById('new-client-form');
        const totalClientsValue = document.getElementById('total-clients-value');
        const newClientsDesc = document.getElementById('new-clients-desc');
        const viewAllSessionsBtn = document.getElementById('view-all-sessions-btn');
        const settingsLink = document.getElementById('settings-link'); // New reference
        
        // Modal content areas
        const modalTitle = document.getElementById('modal-title');
        const formContent = document.getElementById('add-client-form-content');
        const detailsContent = document.getElementById('client-details-content');


        // --- UTILITY FUNCTIONS ---
        
        /**
         * Returns a copy of the clients array sorted by join date (newest first).
         */
        function getSortedClients() {
            // Sort by joinDate descending (newest first)
            return [...clients].sort((a, b) => new Date(b.joinDate) - new Date(a.joinDate));
        }

        /**
         * Returns today's date in YYYY-MM-DD format.
         */
        function getTodayDate() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        }
        
        /**
         * Cleans up modal classes and opens it.
         * @param {string} title 
         * @param {boolean} isLarge 
         */
        function setupAndOpenModal(title, isLarge = false) {
             // Reset modal size class
            modalContentArea.classList.remove('lg');
            if (isLarge) {
                modalContentArea.classList.add('lg');
            }
            modalTitle.textContent = title;
            modal.classList.add('open');
        }


        // --- RENDER FUNCTIONS ---

        /**
         * Renders the client data array into the HTML table.
         */
        function renderClientsTable() {
            tableBody.innerHTML = ''; // Clear existing rows
            
            const sortedClients = getSortedClients();

            sortedClients.forEach((client, index) => {
                const row = document.createElement('tr');
                
                const statusClass = client.status === 'Active' ? 'good' : 'waiting';

                row.innerHTML = `
                    <td>${client.name}</td>
                    <td>${client.age}</td>
                    <td>${client.gender}</td>
                    <td>${client.bmi.toFixed(1)}</td>
                    <td>${client.joinDate}</td>
                    <td><span class="badge ${statusClass}">${client.status}</span></td>
                    <td>
                        <!-- data-client-index holds the index in the CURRENTLY sorted array -->
                        <button class="btn primary view-client-btn" data-client-index="${index}">View</button>
                        <button class="btn success message-client-btn" data-client-index="${index}">Message</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Update dashboard stats
            totalClientsValue.textContent = clients.length;
            newClientsDesc.textContent = `${newClientsCount} new clients this month`;
        }

        /**
         * Renders the sessions scheduled for today.
         */
        function renderSessionsTable() {
            todaysSessionsBody.innerHTML = ''; // Clear existing rows

            const today = getTodayDate();
            const todaySessions = sessions.filter(s => s.date === today);

            if (todaySessions.length === 0) {
                todaysSessionsBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #999; padding: 20px;">
                            No sessions scheduled for today (${today}). Use the "Add New Session" button to schedule one!
                        </td>
                    </tr>
                `;
                return;
            }

            todaySessions.forEach((session, index) => {
                const statusClass = session.status === 'Completed' ? 'completed' : 'upcoming';
                const actionText = session.status === 'Completed' ? 'Notes/Review' : 'Edit';

                // We store the session ID directly for easy lookup later
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${session.client}</td>
                    <td>${session.time}</td>
                    <td>${session.type}</td>
                    <td><span class="badge ${statusClass}">${session.status}</span></td>
                    <td>
                        <button class="btn primary session-edit-btn" 
                                data-session-id="${session.id}" 
                                data-is-completed="${session.status === 'Completed' ? 'true' : 'false'}"
                                data-is-new="false"
                                style="padding: 8px 12px; font-size: 11px;">${actionText}</button>
                    </td>
                `;
                todaysSessionsBody.appendChild(row);
            });
        }
        
        // --- ACTION HANDLERS ---
        
        /**
         * Opens the modal for adding a new client.
         */
        function openClientModal() {
            // Reset to form view (default for Add Client button)
            formContent.style.display = 'block';
            detailsContent.style.display = 'none';
            setupAndOpenModal("Add New Client Details", false);
        }

        /**
         * Closes the modal and resets the form.
         */
        function closeModal() {
            modal.classList.remove('open');
            clientForm.reset();
            // Reset content visibility back to default (form)
            formContent.style.display = 'block';
            detailsContent.style.display = 'none';
        }

        /**
         * Handles form submission to add a new client.
         * @param {Event} event 
         */
        function handleClientFormSubmit(event) {
            event.preventDefault();

            const formData = new FormData(clientForm);
            
            // Generate current date for join date
            const now = new Date();
            const joinDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            
            // Generate mock email for new client
            const name = formData.get('name');
            const nameParts = name.toLowerCase().split(' ');
            const mockEmail = nameParts.length > 1 
                ? `${nameParts[0]}.${nameParts[nameParts.length - 1]}@newclient.com`
                : `${nameParts[0]}.client@newclient.com`;

            const newClient = {
                id: clients.length + 1, // Simple ID for mock data
                name: name,
                age: parseInt(formData.get('age')),
                gender: formData.get('gender'),
                bmi: parseFloat(formData.get('bmi')),
                joinDate: joinDate,
                status: formData.get('status'),
                email: mockEmail // Added email here
            };

            // Add new client to the data array
            clients.push(newClient);
            newClientsCount++; // Increment the new clients count

            // Re-render table and update stats
            renderClientsTable();

            // Close the modal
            closeModal();
        }

        /**
         * Opens the modal to add a new session.
         */
        function openAddSessionModal() {
            showSessionForm(null);
        }

        /**
         * Handles saving/updating a session from the modal form.
         * Exposed globally for the inline onclick handler.
         */
        window.handleSessionFormSubmit = function(isNew, sessionId) {
            const statusDiv = document.getElementById('session-save-status');
            const clientName = document.getElementById('session-client').value;
            const date = document.getElementById('session-date').value;
            const time = document.getElementById('session-time').value;
            const type = document.getElementById('session-type').value;
            const status = document.getElementById('session-status').value;
            const notes = document.getElementById('session-notes-area').value;
            
            if (!clientName || !date || !time || !type || !status) {
                statusDiv.textContent = 'Please fill in all fields.';
                statusDiv.style.color = '#e74c3c';
                return;
            }

            const sessionData = {
                client: clientName,
                date: date,
                time: time,
                type: type,
                status: status,
                notes: notes
            };

            if (isNew) {
                // Add new session
                sessionData.id = nextSessionId++;
                sessions.push(sessionData);
                statusDiv.textContent = `New session created successfully!`;
            } else {
                // Update existing session
                const index = sessions.findIndex(s => s.id == sessionId);
                if (index !== -1) {
                    sessions[index] = { ...sessions[index], ...sessionData };
                    statusDiv.textContent = `Session updated successfully!`;
                } else {
                    statusDiv.textContent = `Error: Session ID ${sessionId} not found.`;
                    statusDiv.style.color = '#e74c3c';
                    return;
                }
            }

            // Re-render today's sessions table
            renderSessionsTable();
            
            statusDiv.style.color = 'rgb(0, 188, 140)';
            
            setTimeout(() => {
                closeModal();
            }, 1500);
        }

        /**
         * Displays the session notes/edit interface in the modal.
         * @param {object | null} sessionData The session object to edit, or null for new session.
         */
        function showSessionForm(sessionData) {
            const isNew = sessionData === null;
            const sessionId = isNew ? null : sessionData.id;
            
            formContent.style.display = 'none';
            detailsContent.style.display = 'block';
            setupAndOpenModal(isNew ? "Schedule New Session" : `Edit Session: ${sessionData.client}`, false);

            const clientOptions = clients.map(c => 
                `<option value="${c.name}" ${sessionData && c.name === sessionData.client ? 'selected' : ''}>${c.name}</option>`
            ).join('');

            const statusOptions = ['Upcoming', 'Completed', 'Cancelled'].map(s => 
                `<option value="${s}" ${sessionData && s === sessionData.status ? 'selected' : ''}>${s}</option>`
            ).join('');

            const isCompleted = sessionData && sessionData.status === 'Completed';
            const notesPlaceholder = isCompleted 
                ? "Enter detailed feedback, performance metrics, and next session plan here..."
                : "Record initial goals, preparation status, or schedule reminders...";
            const initialNotes = isNew ? '' : sessionData.notes;
            const submitButtonText = isNew ? 'Schedule Session' : (isCompleted ? 'Update Notes/Review' : 'Save Changes');

            detailsContent.innerHTML = `
                <form id="session-form">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="session-client">Client</label>
                            <select id="session-client" name="client" required>
                                <option value="">Select Client</option>
                                ${clientOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="session-type">Type</label>
                            <input type="text" id="session-type" name="type" required placeholder="e.g., Cardio, Yoga" value="${sessionData ? sessionData.type : ''}">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="session-date">Date</label>
                            <input type="date" id="session-date" name="date" required value="${sessionData ? sessionData.date : getTodayDate()}">
                        </div>
                        <div class="form-group">
                            <label for="session-time">Time (Start)</label>
                            <input type="text" id="session-time" name="time" required placeholder="e.g., 10:00 AM - 11:00 AM" value="${sessionData ? sessionData.time : '10:00 AM - 11:00 AM'}">
                        </div>
                        <div class="form-group">
                            <label for="session-status">Status</label>
                            <select id="session-status" name="status" required>
                                ${statusOptions}
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="session-notes-area" style="font-size: 16px;">Session Notes/Details</label>
                        <textarea id="session-notes-area" rows="8" placeholder="${notesPlaceholder}" style="resize: vertical;">${initialNotes}</textarea>
                    </div>

                    <div id="session-save-status" style="margin-bottom: 15px; font-size: 12px; color: #999; text-align: center;"></div>

                    <div class="form-actions">
                        <button type="button" class="btn primary" onclick="window.handleSessionFormSubmit(${isNew}, ${sessionId})">${submitButtonText}</button>
                        ${!isNew ? `<button type="button" class="btn danger" style="margin-left: 10px;" onclick="window.deleteSession(${sessionId})">Delete Session</button>` : ''}
                        <button type="button" class="btn" style="background: #3e3e3e; color: white; margin-left: 10px;" onclick="closeModal()">Close</button>
                    </div>
                </form>
            `;
        }

        /**
         * Handles the mock deletion of a session.
         * Exposed globally for the inline onclick handler.
         */
        window.deleteSession = function(sessionId) {
            const confirmation = window.confirm('Are you sure you want to delete this session? This action cannot be undone.');
            if (confirmation) {
                const initialLength = sessions.length;
                sessions = sessions.filter(s => s.id !== sessionId);

                if (sessions.length < initialLength) {
                    renderSessionsTable();
                    closeModal();
                    // Optional: Show success message in the main view
                    const header = document.querySelector('.header');
                    const deleteMsg = document.createElement('p');
                    deleteMsg.textContent = 'Session successfully deleted.';
                    deleteMsg.style = 'color: #e74c3c; font-weight: 600; margin-top: 10px; text-align: center; width: 100%;';
                    header.appendChild(deleteMsg);
                    setTimeout(() => deleteMsg.remove(), 3000);

                } else {
                    alert('Error: Could not find session to delete.');
                }
            }
        }
        
        /**
         * Displays the details of a specific client in the modal.
         * [Existing function kept for completeness]
         */
        function showClientDetails(index) {
            const client = getSortedClients()[index];
            
            formContent.style.display = 'none';
            detailsContent.style.display = 'block';
            setupAndOpenModal(`Client Profile: ${client.name}`, false);

            detailsContent.innerHTML = `
                <div style="padding: 15px; border-radius: 8px; background: #2a2a2a; margin-bottom: 20px; border-left: 3px solid rgb(0, 188, 140);">
                    <p style="font-weight: 600; color: rgb(0, 188, 140); margin-bottom: 10px; font-size: 1.2em;">Key Metrics</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <p><strong>Age:</strong> ${client.age}</p>
                        <p><strong>Gender:</strong> ${client.gender}</p>
                        <p><strong>BMI:</strong> ${client.bmi.toFixed(1)}</p>
                        <p><strong>Status:</strong> <span class="badge ${client.status === 'Active' ? 'good' : 'waiting'}">${client.status}</span></p>
                    </div>
                    <p style="margin-top: 15px; font-size: 14px;"><strong>Email:</strong> ${client.email}</p>
                    <p style="margin-top: 5px; font-size: 14px;"><strong>Joined:</strong> ${client.joinDate}</p>
                </div>
                
                <p style="color: #ccc; margin-bottom: 15px;">This view provides an overview. Full analytics are available on the dedicated client page.</p>

                <div class="form-actions">
                    <button type="button" class="btn primary" onclick="closeModal()">Close Profile</button>
                </div>
            `;
        }
        
        /**
         * Displays the comprehensive Settings menu with nested Logout.
         * [Existing function kept for completeness]
         */
        function showSettings() {
            formContent.style.display = 'none';
            detailsContent.style.display = 'block';
            setupAndOpenModal("Trainer Settings & Administration", false);

            detailsContent.innerHTML = `
                <div style="padding: 15px; border-radius: 8px; background: #2a2a2a; margin-bottom: 20px; border-left: 3px solid #3498db;">
                    <p style="font-weight: 600; color: #3498db; margin-bottom: 15px; font-size: 1.2em;">Profile & Security</p>
                    <div class="form-group">
                        <label for="trainer-name-input">Trainer Name</label>
                        <input type="text" id="trainer-name-input" value="Naman Trainer" placeholder="Naman Trainer" disabled>
                    </div>
                    <div class="form-group">
                        <label for="trainer-email-input">Email</label>
                        <input type="email" id="trainer-email-input" value="naman.trainer@health.com" placeholder="email" disabled>
                    </div>
                    <button class="btn primary" style="padding: 8px 15px; font-size: 14px;">Update Info</button>
                    <button type="button" class="btn" style="background: #3e3e3e; color: white; padding: 8px 15px; font-size: 14px; margin-left: 10px;">Change Password</button>
                </div>
                
                <div style="padding: 15px; border-radius: 8px; background: #2a2a2a; margin-bottom: 20px; border-left: 3px solid #f39c12;">
                    <p style="font-weight: 600; color: #f39c12; margin-bottom: 10px; font-size: 1.2em;">Notification Preferences</p>
                    <label class="checkbox-group">
                        <input type="checkbox" checked>
                        <span>Email alerts for new clients</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox" checked>
                        <span>In-app reminders 1 hour before session</span>
                    </label>
                    <label class="checkbox-group">
                        <input type="checkbox">
                        <span>Daily summary report email</span>
                    </label>
                </div>

                <div class="form-actions" style="margin-top: 30px; text-align: center;">
                    <button type="button" class="btn" onclick="window.mockLogout()" style="background: #e74c3c; color: white; width: 100%; max-width: 300px; box-shadow: 0 3px 6px rgba(231, 76, 60, 0.4); display: inline-flex; align-items: center; justify-content: center;">
                        <span class="icon" style="margin-right: 10px;">üö™</span> LOGOUT OF HEALTH TRACKER
                    </button>
                </div>
            `;
        }

        /**
         * Mock logout function.
         * [Existing function kept for completeness]
         */
        window.mockLogout = function() {
            // In a real application, this would clear authentication tokens and redirect.
            const userBox = document.querySelector('.user');
            userBox.innerHTML = '<div class="details"><h4>Logged Out</h4><p>Please log in again.</p></div>';
            closeModal();
            // Show a mock notification
            const header = document.querySelector('.header');
            const logoutMsg = document.createElement('p');
            logoutMsg.textContent = 'Successfully logged out.';
            logoutMsg.style = 'color: #e74c3c; font-weight: 600; margin-top: 10px; text-align: center; width: 100%;';
            header.appendChild(logoutMsg);
            setTimeout(() => logoutMsg.remove(), 3000);
        }

        /**
         * Sets up a mock message interface in the modal, styled like a chat composer.
         * [Existing function kept for completeness]
         */
        function sendMessageToClient(index) {
            const client = getSortedClients()[index];

            // Title format: "User Name | Email ID: email@example.com"
            const title = `${client.name} | Email ID: ${client.email}`;

            formContent.style.display = 'none';
            detailsContent.style.display = 'block';
            setupAndOpenModal(title, false);

            // Start with an empty message history
            detailsContent.innerHTML = `
                <div class="chat-container">
                    <div style="padding: 10px; background: rgb(34, 34, 34); border-bottom: 1px solid #444; font-weight: 600; text-align: center; font-size: 14px; border-radius: 8px 8px 0 0;">
                        Messaging via Email System
                    </div>
                    <div id="chat-messages" class="chat-messages">
                        <div style="text-align: center; color: #999; padding: 10px; font-size: 13px;">
                            This is a new conversation. Start messaging!
                        </div>
                    </div>
                    
                    <div class="chat-input-area">
                        <!-- Hidden file input, triggered by the attachment button -->
                        <input type="file" id="optional-upload" accept=".pdf, .doc, .docx, .jpg, .png" style="display: none;">
                        
                        <!-- Attachment button -->
                        <button type="button" class="attachment-btn" onclick="document.getElementById('optional-upload').click()">üìé</button>
                        
                        <!-- Text input. Enter key sends message -->
                        <input type="text" id="message-input" placeholder="Compose email body..." onkeydown="if(event.key === 'Enter') { event.preventDefault(); window.sendMockMessage('${client.name}'); }">
                        
                        <!-- Send button -->
                        <button type="button" class="send-btn" onclick="window.sendMockMessage('${client.name}')">‚ñ∂</button>
                    </div>
                    <div id="message-status" style="margin-top: 5px; font-size: 11px; color: #999; text-align: center;"></div>
                </div>
            `;
        }

        /**
         * Handles the mock sending of the message and simulates a chat reply.
         * [Existing function kept for completeness]
         */
        window.sendMockMessage = function(clientName) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageInput = document.getElementById('message-input');
            const fileInput = document.getElementById('optional-upload');
            const statusDiv = document.getElementById('message-status');

            const messageText = messageInput.value.trim();
            const uploadedFile = fileInput.files[0];
            
            if (messageText === "" && !uploadedFile) {
                statusDiv.textContent = "Please enter a message or select a file.";
                statusDiv.style.color = '#e74c3c';
                return;
            }
            
            // Clear status message
            statusDiv.textContent = '';

            const now = new Date();
            const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Remove the initial "new conversation" message if it exists
            const initialMessage = messagesContainer.querySelector('div[style*="text-align: center"]');
            if (initialMessage) {
                messagesContainer.removeChild(initialMessage);
            }

            let messageContent = messageText ? `<p>${messageText}</p>` : '';
            let replyText = `I received your email in my inbox! I will reply officially in a moment.`; 

            if (uploadedFile) {
                messageContent += `<div class="attachment-info">üìé ${uploadedFile.name} (${(uploadedFile.size / 1024).toFixed(1)} KB)</div>`;
                replyText = `Thanks for sending the attachment (${uploadedFile.name}) to my email! I'll review it now.`;
            }

            // 1. Append Sent Message
            const sentMessage = document.createElement('div');
            sentMessage.className = 'message-bubble sent';
            sentMessage.innerHTML = `${messageContent}<span class="timestamp">${time}</span>`;
            messagesContainer.appendChild(sentMessage);

            // Clear inputs and file
            messageInput.value = "";
            fileInput.value = "";
            
            // Scroll to the latest message
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // 2. Simulate Auto-Reply (Received message)
            setTimeout(() => {
                const autoReply = document.createElement('div');
                autoReply.className = 'message-bubble received';
                const replyTime = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                autoReply.innerHTML = `<p>${replyText}</p><span class="timestamp">${replyTime}</span>`;
                messagesContainer.appendChild(autoReply);
                
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 1500); // 1.5 seconds delay

        }
        
        /**
         * Renders the comprehensive list of all sessions in a large modal.
         * [Existing function kept for completeness]
         */
        function showAllSessions() {
            formContent.style.display = 'none';
            detailsContent.style.display = 'block';
            setupAndOpenModal("All Session History (Sortable)", true); // True sets the larger modal size

            // Sort sessions by date descending (newest first)
            const sortedSessions = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));

            let tableRows = '';
            sortedSessions.forEach(session => {
                const statusClass = session.status === 'Completed' ? 'good' : 'upcoming';
                // Use session-edit-btn class for consistent logic
                tableRows += `
                    <tr>
                        <td>${session.date}</td>
                        <td>${session.client}</td>
                        <td>${session.time}</td>
                        <td>${session.type}</td>
                        <td><span class="badge ${statusClass}">${session.status}</span></td>
                        <td>
                            <button class="btn primary session-edit-btn" 
                                data-session-id="${session.id}" 
                                data-is-completed="${session.status === 'Completed' ? 'true' : 'false'}"
                                data-is-new="false"
                                style="padding: 5px 10px; font-size: 10px;">Details/Edit</button>
                        </td>
                    </tr>
                `;
            });

            detailsContent.innerHTML = `
                <p style="color: #ccc; margin-bottom: 15px;">This view contains all recorded client sessions, past and future.</p>
                <div class="sessions-table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Client</th>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn primary" onclick="closeModal()">Close List</button>
                </div>
            `;
        }
        
        window.closeModal = closeModal; // Expose closeModal globally for inline onclick

        // --- EVENT LISTENERS ---
        
        // 1. Open Modal for Add Client
        addClientBtn.addEventListener('click', openClientModal);

        // 2. Open Modal for Add Session (New listener)
        addSessionBtn.addEventListener('click', openAddSessionModal);

        // 3. Open Modal for Settings
        settingsLink.addEventListener('click', (e) => {
            e.preventDefault(); // Prevent default link behavior
            showSettings();
        });

        // 4. Close Modal when the 'x' button is clicked
        closeModalBtn.addEventListener('click', closeModal);
        
        // 5. Close Modal when clicking outside the content
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });

        // 6. Handle Client Form Submission
        clientForm.addEventListener('submit', handleClientFormSubmit);

        // 7. Delegate table button clicks (View/Message)
        tableBody.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('view-client-btn')) {
                const index = target.dataset.clientIndex;
                showClientDetails(index);
            } else if (target.classList.contains('message-client-btn')) {
                const index = target.dataset.clientIndex;
                sendMessageToClient(index);
            }
        });
        
        // 8. View All Sessions button
        viewAllSessionsBtn.addEventListener('click', showAllSessions);
        
        // 9. Delegate Session Edit/Notes button clicks (Today's Sessions and View All Sessions table)
        todaysSessionsBody.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('session-edit-btn')) {
                const sessionId = parseInt(target.dataset.sessionId);
                const session = sessions.find(s => s.id === sessionId);
                if (session) {
                    showSessionForm(session);
                }
            }
        });

        // Also add delegation for the larger modal content area (for "View All" buttons)
        modal.addEventListener('click', (e) => {
            const target = e.target;
            if (target.classList.contains('session-edit-btn') && modalContentArea.classList.contains('lg')) {
                const sessionId = parseInt(target.dataset.sessionId);
                const session = sessions.find(s => s.id === sessionId);
                if (session) {
                    showSessionForm(session);
                }
            }
        });


        // Initial renders when the page loads
        window.addEventListener('load', () => {
            renderClientsTable();
            renderSessionsTable(); // Render sessions on load
        });

    </script>
</body>
</html>
